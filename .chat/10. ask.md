上述代码有需要优化，重构的地方吗？

可以把优化后的完整代码展示吗？

有些注释很重要，尽量保留

请仔细检查下，每个模块有代码错误吗？

修改后的完整代码，请保留当时的注释。

需要恢复 n-step 逻辑
